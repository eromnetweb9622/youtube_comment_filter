{% extends "base.html" %}

{% block content %}

<h1 class="text-3xl font-extrabold mb-8 text-slate-100">
  ìœ íŠœë¸Œ ëŒ“ê¸€ AI ë¶„ì„
</h1>

<div class="flex gap-4 mb-8">
  <input
    id="youtube-url"
    class="flex-1 p-4 rounded-xl bg-slate-900 border border-slate-700 text-slate-200 focus:outline-none focus:ring-2 focus:ring-indigo-500"
    placeholder="ìœ íŠœë¸Œ ì˜ìƒ URLì„ ì…ë ¥í•˜ì„¸ìš”"
  />
  <button
    onclick="fetchComments()"
    class="px-8 py-4 rounded-xl bg-indigo-600 hover:bg-indigo-500 font-bold text-white transition-all shadow-lg"
  >
    ë¶„ì„ ì‹œì‘
  </button>
</div>

<div
  id="ai-summary"
  class="hidden mb-10 p-6 bg-slate-900 rounded-2xl border border-slate-800 shadow-inner"
>
  <h2 class="font-bold mb-3 text-indigo-400 flex items-center gap-2">
    <span class="text-xl">ğŸ“Š</span> AI ìš”ì•½
  </h2>
  <p id="summary-text" class="text-slate-300 leading-relaxed"></p>
</div>

<div id="comment-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
  </div>

<script>
async function fetchComments() {
    const urlInput = document.getElementById('youtube-url').value.trim();
    if (!urlInput) {
        alert("URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    // ë¡œë”© í‘œì‹œ (ì„ íƒ ì‚¬í•­: ë²„íŠ¼ ë¹„í™œì„±í™” ë“±)
    const commentList = document.getElementById('comment-list');
    commentList.innerHTML = '<div class="col-span-full text-center py-10 text-slate-500">ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>';

    try {
        const response = await fetch(`/api/comments?url=${encodeURIComponent(urlInput)}`);
        
        // ğŸ”’ ê´€ë¦¬ì ê¶Œí•œ ì²´í¬ (401 ì—ëŸ¬)
        if (response.status === 401) {
            const data = await response.json();
            alert(data.message || "ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            window.location.href = "/admin/login";
            return;
        }

        const data = await response.json();

        if (data.error) {
            alert("ë¶„ì„ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + data.error);
            commentList.innerHTML = '';
            return;
        }

        // --- ë°ì´í„° ë Œë”ë§ ë¡œì§ ì‹œì‘ ---
        const summaryBox = document.getElementById('ai-summary');
        const summaryText = document.getElementById('summary-text');

        summaryBox.classList.remove('hidden');

        // [ìˆ˜ì •] ë°ì´í„° ë°©ì–´ ì½”ë“œ ì ìš© (undefined ë°©ì§€)
        const total = data.summary.total || 0;
        const abuseCount = data.summary.abuse || 0;
        const spamCount = data.summary.spam || 0;
        const dangerCount = abuseCount + spamCount;

        summaryText.textContent = `ì´ ${total}ê°œì˜ ëŒ“ê¸€ì„ ë¶„ì„í•œ ê²°ê³¼, ${dangerCount}ê°œ(ìš•ì„¤/ë¹„ë°©: ${abuseCount}, ìŠ¤íŒ¸: ${spamCount})ì˜ ìœ„í—˜ ìš”ì†Œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;

        // [ìˆ˜ì •] ëŒ“ê¸€ ë¦¬ìŠ¤íŠ¸ ë§¤í•‘ ë¡œì§ (label ì˜ë¬¸ -> í•œê¸€ ë³€í™˜)
        commentList.innerHTML = data.comments.map(c => {
            let labelDisplayName = "ì •ìƒ";
            let labelClass = "bg-green-900/40 text-green-400 border-green-800";

            // ì„œë²„ ì‘ë‹µ label ê°’ì— ë”°ë¥¸ ë¶„ë¥˜ ë° ìŠ¤íƒ€ì¼ ì§€ì •
            if (c.label === 'abuse') {
                labelDisplayName = "ìš•ì„¤/ë¹„ë°©";
                labelClass = "bg-red-900/40 text-red-400 border-red-800";
            } else if (c.label === 'spam') {
                labelDisplayName = "ê´‘ê³ /ìŠ¤íŒ¸";
                labelClass = "bg-yellow-900/40 text-yellow-400 border-yellow-800";
            }

            return `
                <div class="p-6 bg-slate-900 rounded-2xl border border-slate-800 flex flex-col h-full hover:border-slate-600 transition-colors shadow-sm">
                    <p class="font-bold mb-3 text-slate-100 flex items-center gap-2">
                        <span class="text-xs text-slate-500">@</span>${c.author}
                    </p>
                    <p class="text-slate-400 mb-6 text-sm leading-relaxed flex-grow">
                        "${c.text}"
                    </p>
                    <div class="mt-auto">
                        <span class="px-3 py-1 rounded-full text-xs font-bold border ${labelClass}">
                            ${labelDisplayName}
                        </span>
                    </div>
                </div>
            `;
        }).join('');
        // --- ë°ì´í„° ë Œë”ë§ ë¡œì§ ë ---

    } catch (err) {
        console.error(err);
        alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        commentList.innerHTML = '';
    }
}
</script>

{% endblock %}